<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>√Ålbum - Fot√≥grafo Profesional</title>
  <link rel="stylesheet" href="/css/style.css" />
  <style>
    .photo-gallery {
      display: flex;
      flex-wrap: wrap;
      gap: 15px;
      justify-content: center;
      padding: 20px;
    }
    .photo-item {
      position: relative;
    }
    .photo-gallery img {
      width: 200px;
      border-radius: 8px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.2);
      cursor: pointer;
      transition: transform 0.3s ease;
    }
    .photo-gallery img:hover {
      transform: scale(1.05);
    }
    #photoControls {
      text-align: center;
      margin: 1rem;
    }
    .photo-delete {
      position: absolute;
      top: 4px;
      right: 4px;
      background: rgba(255,255,255,0.8);
      border: none;
      cursor: pointer;
      border-radius: 50%;
      font-size: 1rem;
    }
    #backBtn {
      margin: 20px;
      color: blue;
      text-decoration: underline;
      cursor: pointer;
    }
  </style>
</head>
<body>
<header>
  <div class="header-left">
    <img src="/img/logo.png" alt="Logo Fot√≥grafo" class="logo" />
    <span class="branding">Clic Y Color</span>
  </div>
  <span class="site-title">Fot√≥grafo Profesional</span>
  <nav>
    <ul>
      <li><a href="../static/index.html">Inicio</a></li>
      <li class="dropdown">
        <a href="../static/portafolio.html">Portafolio ‚ñæ</a>
        <ul class="dropdown-menu">
          <li><a href="../static/categoria.html?event=Bodas">Bodas</a></li>
          <li><a href="../static/categoria.html?event=Bautizos">Bautizos</a></li>
          <li><a href="../static/categoria.html?event=Comuniones">Comuniones</a></li>
          <li><a href="../static/categoria.html?event=Retratos">Retratos</a></li>
          <li><a href="../static/categoria.html?event=Conciertos">Conciertos</a></li>
        </ul>
      </li>
      <li><a href="../static/login.html">Iniciar sesi√≥n</a></li>
      <li><a href="../static/contacto.html">Contacto</a></li>
    </ul>
  </nav>
</header>

<header>
  <a id="backBtn" href="#">‚Üê Volver</a>
  <h1 id="albumTitle" style="text-align:center;"></h1>
</header>

<!-- Controles de foto (subida) -->
<div id="photoControls"></div>

<section id="photoGallery" class="photo-gallery"></section>

<script>
  let currentRoles = [];

  async function fetchUserRoles() {
    try {
      const res = await fetch('/api/me', { credentials: 'include' });
      if (!res.ok) throw new Error();
      const me = await res.json();
      currentRoles = me.roles;
    } catch {
      currentRoles = [];
    }
  }

  function canEdit() {
    return currentRoles.includes('ROLE_ADMIN') ||
            currentRoles.includes('ROLE_PHOTOGRAPHER');
  }

  function getQueryParam(param) {
    return new URLSearchParams(window.location.search).get(param);
  }

  const albumId = getQueryParam('albumId');
  const volverA = getQueryParam('volver') || 'portafolio';
  const cap = volverA.charAt(0).toUpperCase() + volverA.slice(1);
  document.getElementById('backBtn').href = `categoria.html?event=${encodeURIComponent(cap)}`;

  if (!albumId) {
    alert('No se ha especificado un √°lbum');
    location.href = document.getElementById('backBtn').href;
  }

  async function loadAlbumPhotos() {
    await fetchUserRoles();

    // Renderizar controles de subir si puede
    const ctrl = document.getElementById('photoControls');
    ctrl.innerHTML = '';
    if (canEdit()) {
      ctrl.innerHTML = `
        <input type="file" id="fileInput" multiple />
        <button id="btnUpload">Subir Fotos</button>
      `;
      document.getElementById('btnUpload').addEventListener('click', async () => {
        const files = document.getElementById('fileInput').files;
        const fd = new FormData();
        for (let f of files) fd.append('files', f);
        fd.append('albumId', albumId);
        const res = await fetch('/api/photos/upload-multiple', {
          method: 'POST',
          credentials: 'include',
          body: fd
        });
        if (res.ok) loadAlbumPhotos();
        else alert('Error al subir fotos');
      });
    }

    // Cargar nombre del √°lbum
    try {
      const alb = await (await fetch(`/api/albums/${albumId}`, { credentials: 'include' })).json();
      document.getElementById('albumTitle').textContent = alb.name;
    } catch {
      document.getElementById('albumTitle').textContent = '√Ålbum';
    }

    // Cargar fotos
    try {
      const photos = await (await fetch(`/api/photos/by-album/${albumId}`, { credentials: 'include' })).json();
      const gallery = document.getElementById('photoGallery');
      gallery.innerHTML = '';
      if (!photos.length) {
        gallery.innerHTML = '<p>No hay fotos en este √°lbum.</p>';
        return;
      }
      photos.forEach(p => {
        const wrapper = document.createElement('div');
        wrapper.className = 'photo-item';

        const img = document.createElement('img');
        img.src = p.url;
        img.alt = p.description || 'Foto';
        img.addEventListener('click', () => {
          modalImg.src = p.url;
          modal.style.display = 'flex';
        });
        wrapper.appendChild(img);

        if (canEdit()) {
          const btnDel = document.createElement('button');
          btnDel.className = 'photo-delete';
          btnDel.textContent = 'üóëÔ∏è';
          btnDel.title = 'Eliminar foto';
          btnDel.addEventListener('click', async e => {
            e.stopPropagation();
            if (!confirm('¬øEliminar esta foto?')) return;
            const res = await fetch(`/api/photos/${p.id}`, {
              method: 'DELETE',
              credentials: 'include'
            });
            if (res.ok) loadAlbumPhotos();
            else alert('Error al borrar foto');
          });
          wrapper.appendChild(btnDel);
        }

        gallery.appendChild(wrapper);
      });
    } catch {
      document.getElementById('photoGallery').innerHTML = '<p>Error cargando fotos.</p>';
    }
    // ‚Ä¶dentro de loadAlbumPhotos(), donde montas el bot√≥n:
    if (canEdit()) {
      ctrl.innerHTML = `
    <input type="file" id="fileInput" multiple />
    <button id="btnUpload">Subir Fotos</button>
  `;
      document.getElementById('btnUpload').addEventListener('click', async () => {
        const files = document.getElementById('fileInput').files;
        if (!files.length) return alert('Selecciona al menos una foto.');

        const fd = new FormData();
        for (const f of files) fd.append('files', f);
        fd.append('albumId', albumId);

        const res = await fetch('/api/photos/upload-multiple', {
          method: 'POST',
          credentials: 'include',
          body: fd
        });

        // 1) ¬øNos redirigi√≥ al login?
        if (res.redirected) {
          alert('Tu sesi√≥n ha expirado. Vas a iniciar sesi√≥n de nuevo.');
          return window.location.href = res.url;
        }

        // 2) ¬øArchivo demasiado grande?
        if (res.status === 413) {
          return alert('Alguno de los archivos es demasiado grande. M√°ximo permitido 10 MB.');
        }

        // 3) Otros errores
        if (!res.ok) {
          console.error('Upload fallido:', res.status, await res.text());
          return alert('Error subiendo fotos. Revisa la consola para m√°s detalles.');
        }

        // 4) √âxito: limpiamos input y recargamos galer√≠a
        document.getElementById('fileInput').value = '';
        loadAlbumPhotos();
      });
    }

  }

  loadAlbumPhotos();
</script>

<!-- Modal para ver foto ampliada -->
<div id="modal" style="
    display:none;
    position:fixed; top:0; left:0;
    width:100vw; height:100vh;
    background:rgba(0,0,0,0.8);
    justify-content:center;
    align-items:center;
    z-index:1000;
  ">
  <img id="modalImg" style="max-width:90vw; max-height:90vh; border-radius:8px;" />
</div>

<footer>
  <div class="footer-social">
    <a href="https://instagram.com/clicycolor" aria-label="Instagram" target="_blank">
      <img src="/img/instagram.png" alt="Instagram" class="social-icon" />
    </a>
    <a href="https://wa.me/0034603109882" aria-label="WhatsApp" target="_blank">
      <img src="/img/whatsapp.png" alt="WhatsApp" class="social-icon" />
    </a>
  </div>
  <div class="footer-content">
    <p>&copy; 2025 Clic y Color. Todos los derechos reservados.</p>
    <a href="#terms" class="terms-link">T√©rminos y Condiciones</a>
  </div>
</footer>

<div id="terms" class="terms-container">
  <h2>T√©rminos y Condiciones</h2>
  <p>Aqu√≠ van los t√©rminos y condiciones de uso...</p>
  <button onclick="document.getElementById('terms').style.display='none'">Cerrar</button>
</div>

</body>
</html>
