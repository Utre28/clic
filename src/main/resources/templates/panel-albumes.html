<!DOCTYPE html>
<html lang="es" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8" />
    <title>Álbumes del Evento</title>
    <link rel="stylesheet" th:href="@{/css/style.css}" />
</head>
<body>
<div th:replace="~{navbar :: navbar}"></div>
<div th:replace="~{fragments/scripts :: script}"></div>

<a id="backBtn" href="#">Volver</a>

<div class="panel-container">
    <h1 class="panel-header" th:text="'Álbumes de ' + ${evento.name}">Álbumes del Evento</h1>

    <!-- Mensaje de éxito o error tras borrar fotos -->
    <div id="mensaje-flash" th:if="${mensaje}" style="color:green; text-align:center; margin-bottom:1rem;">
        <p th:text="${mensaje}"></p>
    </div>
    <div id="mensaje-flash-error" th:if="${message}" style="color:red; text-align:center; margin-bottom:1rem;">
        <p th:text="${message}"></p>
    </div>

    <div th:if="${#lists.isEmpty(albumes)}">
        <p>No hay álbumes para este evento.</p>
    </div>

    <div th:each="album : ${albumes}" class="album-block">
        <div class="album-header" style="display: flex; align-items: center; justify-content: space-between;">
            <h2 th:text="${album.name}" style="flex:1; text-align:center; margin:0;">Nombre del Álbum</h2>
            <form id="borrarEventosForm" th:action="@{'/panel/albumes/' + ${album.id} + '/borrar'}" method="post" style="display:inline;">
                <input type="hidden" name="eventoId" th:value="${evento.id}" />
                <button type="submit" class="btn-borrar" onclick="return confirm('¿Seguro que quieres borrar este álbum?')">Borrar Álbum</button>
            </form>
        </div>
        <div th:if="${albumFotosMap != null and albumFotosMap[album.id] != null and not #lists.isEmpty(albumFotosMap[album.id])}">
            <!-- Formulario para borrar fotos seleccionadas -->
            <form id="borrarFotosForm-[[${album.id}]]" th:action="@{/panel/fotos/borrar-multiple}" method="post">
                <input type="hidden" name="eventoId" th:value="${evento.id}" />
                <div class="fotos-grid">
                    <div th:each="foto : ${albumFotosMap[album.id]}" class="foto-card">
                        <input type="checkbox" name="fotoIds" th:value="${foto.id}" id="foto-${foto.id}" class="foto-checkbox">
                        <label for="foto-${foto.id}">
                            <img th:src="${foto.url}" alt="Foto" class="foto-preview"
                                 style="width:auto; height:auto; max-width:140px; max-height:140px; border-radius:8px; margin-bottom:5px; display:block;"/>
                        </label>
                    </div>
                </div>
                <button type="submit" class="btn-borrar" onclick="return confirmBorrar()" th:if="${#lists.size(albumFotosMap[album.id]) > 0}">Borrar fotos seleccionadas</button>
            </form>
        </div>
        <div th:if="${albumFotosMap == null or albumFotosMap[album.id] == null or #lists.isEmpty(albumFotosMap[album.id])}">
            <p style="color:#888;">No hay fotos en este álbum.</p>
        </div>
    </div>
</div>

<!-- Mensaje de éxito o error -->
<div id="feedbackMessage" style="display:none; padding: 10px; background-color: #4CAF50; color: white; text-align: center; border-radius: 5px; margin-top: 10px;">
    <span id="feedbackText"></span>
</div>

<!-- Modal para mostrar la imagen seleccionada -->
<div id="photoModal" class="photo-modal">
    <div class="modal-content">
        <span class="close" onclick="closeModal()">&times;</span>

        <!-- Flechas de navegación -->
        <button class="prev" onclick="prevImage()">&#10094;</button>

        <!-- Checkbox para seleccionar la foto -->
        <input type="checkbox" id="modalCheckbox" class="foto-checkbox">
        <label for="modalCheckbox">Seleccionar esta foto</label>

        <img id="modalImage" src="" alt="Foto" />

        <button class="next" onclick="nextImage()">&#10095;</button>
    </div>
</div>

<!-- Footer -->
<footer>
    <div class="footer-social">
        <a href="https://instagram.com/clicycolor" aria-label="Instagram" target="_blank">
            <img src="/img/instagram.png" alt="Instagram" class="social-icon" />
        </a>
        <a href="https://wa.me/0034603109882" aria-label="WhatsApp" target="_blank">
            <img src="/img/whatsapp.png" alt="WhatsApp" class="social-icon" />
        </a>
    </div>
    <div class="footer-content">
        <p>&copy; 2025 Clic y Color. Todos los derechos reservados.</p>
        <a href="#" id="terms-link" class="terms-link">Términos y Condiciones</a>
    </div>
</footer>

<!-- Modal de términos -->
<div id="terms" class="terms-container" style="display:none;">
    <div id="terms-content">
        <!-- El contenido de los términos se cargará aquí -->
    </div>
    <button id="close-terms-btn" onclick="document.getElementById('terms').style.display='none'">Cerrar</button>
</div>

<script>
    let fotos = [];
    let fotoActualIndex = 0;
    let fotosSeleccionadas = {};

    function openModal(imgSrc) {
        fotos = [...document.querySelectorAll('.foto-preview')].map(img => img.src);
        fotoActualIndex = fotos.indexOf(imgSrc);

        var modal = document.getElementById("photoModal");
        var modalImage = document.getElementById("modalImage");
        var modalCheckbox = document.getElementById("modalCheckbox");

        modal.style.display = "flex";
        modalImage.src = imgSrc;

        syncCheckbox();
    }

    function closeModal() {
        document.getElementById("photoModal").style.display = "none";
    }

    function prevImage() {
        fotoActualIndex = (fotoActualIndex - 1 + fotos.length) % fotos.length;
        updateModalImage();
    }

    function nextImage() {
        fotoActualIndex = (fotoActualIndex + 1) % fotos.length;
        updateModalImage();
    }

    function updateModalImage() {
        var modalImage = document.getElementById("modalImage");
        fotoActualIndex = (fotoActualIndex + fotos.length) % fotos.length;
        modalImage.src = fotos[fotoActualIndex];
        syncCheckbox();
    }

    function syncCheckbox() {
        var modalImageSrc = document.getElementById("modalImage").src;
        var modalCheckbox = document.getElementById("modalCheckbox");
        modalCheckbox.checked = fotosSeleccionadas[modalImageSrc] || false;

        document.querySelectorAll('.foto-card').forEach(card => {
            var imgPreview = card.querySelector('.foto-preview');
            var checkbox = card.querySelector('.foto-checkbox');
            if (imgPreview.src === modalImageSrc) {
                checkbox.checked = fotosSeleccionadas[modalImageSrc] || false;
            }
        });
    }

    document.addEventListener("DOMContentLoaded", function() {
        // Modal checkbox sync
        document.getElementById("modalCheckbox").addEventListener("change", function () {
            var modalImageSrc = document.getElementById("modalImage").src;
            fotosSeleccionadas[modalImageSrc] = this.checked;
            document.querySelectorAll('.foto-card').forEach(card => {
                var imgPreview = card.querySelector('.foto-preview');
                var checkbox = card.querySelector('.foto-checkbox');
                if (imgPreview.src === modalImageSrc) {
                    checkbox.checked = this.checked;
                }
            });
        });

        // Modal navigation
        document.querySelectorAll('.foto-preview').forEach(img => {
            img.addEventListener('click', function() {
                openModal(this.src);
            });
        });

        document.addEventListener("keydown", function(event) {
            if (document.getElementById("photoModal").style.display === "flex") {
                if (event.key === "ArrowLeft") {
                    fotoActualIndex = (fotoActualIndex - 1 + fotos.length) % fotos.length;
                    updateModalImage();
                } else if (event.key === "ArrowRight") {
                    fotoActualIndex = (fotoActualIndex + 1) % fotos.length;
                    updateModalImage();
                }
            }
            if (event.key === "Escape") {
                closeModal();
            }
        });

        // Ocultar mensaje de éxito/error tras 3 segundos
        setTimeout(function() {
            var msg = document.getElementById('mensaje-flash');
            if (msg) msg.style.display = 'none';
            var msgErr = document.getElementById('mensaje-flash-error');
            if (msgErr) msgErr.style.display = 'none';
        }, 3000);

        // Validación para mostrar mensaje si no hay selección al borrar fotos
        document.querySelectorAll('form[id^="borrarFotosForm-"]').forEach(function(borrarFotosForm) {
            borrarFotosForm.addEventListener('submit', function(e) {
                const checked = borrarFotosForm.querySelectorAll('input[type="checkbox"][name="fotoIds"]:checked');
                if (checked.length === 0) {
                    e.preventDefault();
                    alert('No ha seleccionado ninguna foto.');
                }
            });
        });

        // Botón volver
        const backBtn = document.getElementById('backBtn');
        if (backBtn) {
            if (window.history.length > 1) {
                backBtn.addEventListener('click', function(event) {
                    event.preventDefault();
                    window.history.back();
                });
            } else {
                backBtn.addEventListener('click', function(event) {
                    event.preventDefault();
                    window.location.href = '/panel/eventos';
                });
            }
        }
    });
</script>
</body>
</html>
